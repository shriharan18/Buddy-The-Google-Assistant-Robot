import time
import math
import multiprocessing 
from adafruit_servokit import ServoKit
#import serial
import sys
import os
import re

e = "\xff\xff\xff"

LF = 15 #left flap
LT = 12 #left turn
RT = 13 #right turn
RF = 14 #right flap
NK = 11 #neck

lfmin = 10 #inside =10 vertical =80 ext 150
lfmax = 150
ltmin = 5
ltmax = 180 #vertical =20, front =5, back =140

rtmin = 0
rtmax = 170 #vertical = 150 ,front = 170 ,back = 45

rfmin = 35
rfmax = 180 #vertical 110, inside 180, ext 35

nkmin = 25
nkmax = 70 #right = 40

nkst = 40


startAngles = {
    LF:lfmin + (lfmax-lfmin)/2,
    RF:rfmin + (rfmax-rfmin)/2,
    LT:ltmax,
    RT:rtmin,
    NK:nkst 
    }

kit = ServoKit(channels=16)
"""#try:
#    ser = serial.Serial("/dev/ttyS0", 9600, timeout=5)
#except serial.serialutil.SerialException:
#    print('could not open serial device /dev/ttyS0')
#    exit(1)
if serial.VERSION <= "3.0":
    if not ser.isOpen():
        ser.open()
    else:
        if not ser.is_open:
            ser.open()

def setDownloadBaudrate(ser, baudrate):
    ser.write(b"")
    #ser.write(("whmi-wri " + "," + str(baudrate) + ",0" + e).encode('utf-8'))
    time.sleep(.05)
    ser.baudrate = baudrate
    ser.timeout = .5
    r = ser.read(1)
    if b"\x05" in r:
        return True
    return False
"""

def init():
#    global ser
#    setDownloadBaudrate(ser, 9600)
    
    global kit
    kit.servo[LF].set_pulse_width_range(750, 2700)
    kit.servo[LT].set_pulse_width_range(750, 2700)
    kit.servo[RF].set_pulse_width_range(750, 2700)
    kit.servo[RT].set_pulse_width_range(750, 2700)
    kit.servo[NK].set_pulse_width_range(750, 2700)
    
    global startAngles
    kit.servo[LF].angle = startAngles[LF]
    time.sleep(0.3)
    kit.servo[LT].angle = startAngles[LT]
    time.sleep(0.3)
    kit.servo[RF].angle = startAngles[RF]
    time.sleep(0.3)
    kit.servo[RT].angle = startAngles[RT]
    time.sleep(0.3)
    kit.servo[NK].angle = startAngles[NK]
    time.sleep(0.3)

"""def display(images):
    os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/sample.jpeg'")
    for i in images:
        ser.write(b"p0.pic=")
        ser.write(bytes(str(i), 'utf-8'))
        ser.write(b"\xff\xff\xff")
        time.sleep(0.1)"""
# In this version I use fbi to display the image on Buddy's screen. It is just a proof of concept.
# fbi is too slow for an animation, so later I will need to optimize the images (maybe gif anim)

def display(emotion):
    if emotion == "listen":
        os.system("sudo fbi -T 2 --readahead -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad1.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad2.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad3.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad4.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad5.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad6.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad7.jpg'")

    if emotion == "sad":
        os.system("sudo fbi -T 2 --readahead -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad1.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad2.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad3.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/sad4.jpg'")

    if emotion == "happy":
#        os.system("sudo fbi -t 0.2 -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy1.png' '/home/pi/Buddy/images/happy2.png' '/home/pi/Buddy/images/happy3.png' '/home/pi/Buddy/images/happy4.png' '/home/pi/Buddy/images/happy5.png' '/home/pi/Buddy/images/happy6.png' '/home/pi/Buddy/images/happy7.png'")
        os.system("sudo fbi -T 2 --readahead -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy1.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy2.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy3.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy4.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy5.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy6.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy7.png'")

    if emotion == "angry":
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/angry1.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/angry2.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/angry3.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/angry4.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/angry5.jpg'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/angry6.jpg'")

    if emotion == "default":
        os.system("sudo fbi -T 2 --readahead -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy1.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy2.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy3.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy4.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy5.png'")
        time.sleep(0.2)
        os.system("sudo fbi -T 2 -d /dev/fb1 -noverbose -a '/home/pi/Buddy/images/happy6.png'")




def kit_angle(servoNum, angle, sleepTime):
    kit.servo[servoNum].angle = angle
    
def set_angles(lf=-1, lt=-1, rf=-1, rt=-1, nk=-1):
    if lf >= lfmin and lf <= lfmax:
        p1 = multiprocessing.Process(target=kit_angle, args=(LF,lf, 0., ))
    if rf >= rfmin and rf <= rfmax:
        p2 = multiprocessing.Process(target=kit_angle, args=(RF,rf, 0, ))
        
    if lt >= ltmin and lt <= ltmax:
        p3 = multiprocessing.Process(target=kit_angle, args=(LT,lt,0, ))
    if rt >= rtmin and rt <= rtmax:
        p4 = multiprocessing.Process(target=kit_angle, args=(RT,rt,0, ))
    if nk >= nkmin and nk<=nkmax:    
        p5 = multiprocessing.Process(target=kit_angle, args=(NK,nk,0, ))
    p1.start()
    p2.start()
    p3.start()
    p4.start()
    p5.start()
    
    
def sad():
    set_angles(lf=lfmax, lt=ltmin, rf=rfmin, rt=rtmax, nk=nkmax)
    p = multiprocessing.Process(target=display, args=([13,14,15,16], ))
    p.start()
    time.sleep(1)

def happy():
    print("animation: happy")
    #set_angles(lf=lfmin + (lfmax-lfmin)/2, lt=ltmax/2, rf=rfmin + (rfmax-rfmin)/2, rt=rtmax/2, nk=nkmin) 
    p = multiprocessing.Process(target=display, args=("happy",))
    p.start()
    for i in range(0,2):
        set_angles(lf=lfmin, lt=ltmax/2, rf=rfmax, rt=rtmax/2, nk=nkst)
        time.sleep(0.5)
        set_angles(lf=lfmax, lt=ltmax/2, rf=rfmin, rt=rtmax/2, nk=nkst)
        time.sleep(0.5)
    time.sleep(1)
    
def angry():
    print("animation: angry")
    set_angles(lf=lfmin + (lfmax-lfmin)/2, lt=(ltmax/4)*3, rf=rfmin + (rfmax-rfmin)/2, rt=rtmax/4, nk=nkmin) 
    p = multiprocessing.Process(target=display, args=("angry", ))
    p.start()
    time.sleep(1)
   
def listen():
    print("animation: listen")
    set_angles(lf=lfmin + (lfmax-lfmin)/2, lt=ltmax, rf=rfmin + (rfmax-rfmin)/2, rt=rtmin, nk = nkst)
    p = multiprocessing.Process(target=display, args=([13,14,15,16,17,18,19], ))
    p.start()
    time.sleep(1)
    
def random1():
    set_angles(lf=lfmax, lt=ltmin, rf=rfmin + (rfmax-rfmin)/2, rt=rtmin, nk = nkst)
    p = multiprocessing.Process(target=display, args=([5,4,3,2,1,0], ))
    p.start()
    time.sleep(1)
    
def random2():
    set_angles(lf=lfmin + (lfmax-lfmin)/2, lt=ltmax, rf=rfmin, rt=rtmax, nk = nkst)
    p = multiprocessing.Process(target=display, args=([5,4,3,2,1,0], ))
    p.start()
    time.sleep(1)

def default():
    print("animation: default")
    p = multiprocessing.Process(target=display, args=([0,1,2,3,4,5], ))
    p.start()
    for i in range(0,2):
        set_angles(lf=lfmin, lt=ltmax, rf=rfmin, rt=rtmin, nk=nkst)
        time.sleep(0.5)
        set_angles(lf=lfmax, lt=ltmax, rf=rfmax, rt=rtmin, nk=nkst)
        time.sleep(0.5)
def random4():
    set_angles(lf=lfmin + (lfmax-lfmin)/2, lt=ltmax, rf=rfmin + (rfmax-rfmin)/2, rt=rtmax, nk = nkst)
    p = multiprocessing.Process(target=display, args=([5,4,3,2,1,0], ))
    p.start()
    time.sleep(1)
    
def random5():
    set_angles(lf=lfmin + (lfmax-lfmin)/2, lt=ltmin, rf=rfmin + (rfmax-rfmin)/2, rt=rtmin, nk = nkst)
    p = multiprocessing.Process(target=display, args=([5,4,3,2,1,0], ))
    p.start()
    time.sleep(1)
    
    
def zero():
    angry()



def fear():
    print("animation: fear")
    angry()

def disgust():
    print("animation: disgust")
    angry()

def surprise():
    print("animation: surprise")
    angry()


# to test, you can enable this and execute this file:
print("happy")
happy()
#sad()
time.sleep(10)
print("angry")
angry()

time.sleep(10)
print("listen")
listen()
time.sleep(10)
print("sad")
sad()
