#!/usr/bin/env python3

# imports from google assistant pushtotalk
# not directly needed here but added hoping to reduce the lag
import json
import logging
import os.path

import click
import grpc
import google.auth.transport.grpc
import google.auth.transport.requests
import google.oauth2.credentials

from google.assistant.embedded.v1alpha1 import embedded_assistant_pb2
from google.rpc import code_pb2
from tenacity import retry, stop_after_attempt, retry_if_exception


""" original syntax, did not work for me
try:
    from . import (
        assistant_helpers,
        audio_helpers
    )
except SystemError:
    import assistant_helpers
    import audio_helpers"""

try:
    import assistant_helpers
    import audio_helpers
except SystemError:
    import assistant_helpers
    import audio_helpers


# imports for Porcupine wake word detection :
import struct
import pyaudio
import pvporcupine
import my_params

# finaly for google pushtotalk call
import pushtotalk

porcupine = None
pa = None
audio_stream = None

""" 
filename.pv  : optional. Needed only if you use any language other than English
filename.ppn : required. One per custom wakeword

I use the French language, so I had to download the following model (xx.pv file) and the wakeword.ppn file that I generated is tagged as French
#model_path="/home/liouma/env/lib/python3.9/site-packages/pvporcupine/lib/common/porcupine_params_fr.pv"
For English language, the model.pv is present by default, so nothing is needed, you can just remove the parameter on the following command. 
Also the default wakeword.ppn are present in English.
You can generate your own wakeword files very easily online. For this, just register for free at https://console.picovoice.ai/ 
and choos Porcupine. You can generate 3 wakewords.
In this example I enabled only one wakeword but many can be enabled at the same line with this syntax [word1,word2]
"""

path_to_ppn1="/home/liouma/env/lib/python3.9/site-packages/googlesamples/assistant/grpc/Dis-lapin_fr_raspberry-pi_v2_1_0.ppn"

try:
    porcupine = pvporcupine.create(access_key=my_params.my_access_key, keyword_paths=[path_to_ppn1],model_path="/home/liouma/env/lib/python3.9/site-packages/pvporcupine/lib/common/porcupine_params_fr.pv")
#    porcupine = pvporcupine.create(access_key='Zhqtt5wFE9Y65+lADbo/ZovmajroxWYRK9emv6qlSachBDZephMnVw==', keywords=["picovoice", "/home/liouma/Dis-lapin_fr_raspberry-pi_v2_1_0.ppn"])

    pa = pyaudio.PyAudio()

    audio_stream = pa.open(
                    rate=porcupine.sample_rate,
                    channels=1,
                    format=pyaudio.paInt16,
                    input=True,
                    frames_per_buffer=porcupine.frame_length)

    while True:
        pcm = audio_stream.read(porcupine.frame_length)
        pcm = struct.unpack_from("h" * porcupine.frame_length, pcm)

        keyword_index = porcupine.process(pcm)

        if keyword_index >= 0:
            print("Hotword Detected")
            break

finally:
    if porcupine is not None:
        porcupine.delete()

    if audio_stream is not None:
        audio_stream.close()

    if pa is not None:
            pa.terminate()
#call to google assistant:
pushtotalk.main()
